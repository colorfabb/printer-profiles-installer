name: build-and-release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      CODESIGN_PFX_BASE64: ${{ secrets.CODESIGN_PFX_BASE64 }}
      CODESIGN_PFX_PASSWORD: ${{ secrets.CODESIGN_PFX_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Build EXE (+ optional signing) + SHA256
        shell: pwsh
        run: |
          if ($env:CODESIGN_PFX_BASE64 -and $env:CODESIGN_PFX_PASSWORD) {
            Write-Host "Code signing enabled (secrets provided)." -ForegroundColor Cyan
            $pfxPath = Join-Path $PWD "codesign.pfx"
            try {
              $b64 = ($env:CODESIGN_PFX_BASE64 -replace "\s", "")
              $pfxBytes = [Convert]::FromBase64String($b64)
            }
            catch {
              throw "CODESIGN_PFX_BASE64 is not valid base64 (check copy/paste and line breaks). $_"
            }
            [IO.File]::WriteAllBytes($pfxPath, $pfxBytes)

            # Validate that the PFX can be opened with the supplied password before invoking signtool
            try {
              $flags = [System.Security.Cryptography.X509Certificates.X509KeyStorageFlags]::EphemeralKeySet
              $cert = [System.Security.Cryptography.X509Certificates.X509Certificate2]::new($pfxBytes, $env:CODESIGN_PFX_PASSWORD, $flags)
              Write-Host ("PFX loaded OK. Subject: {0}" -f $cert.Subject) -ForegroundColor Green
              $cert.Dispose()
            }
            catch {
              throw "Unable to open PFX with CODESIGN_PFX_PASSWORD. $_"
            }

            $pw = ConvertTo-SecureString $env:CODESIGN_PFX_PASSWORD -AsPlainText -Force
            ./build-release.ps1 -Sign -PfxPath $pfxPath -PfxPassword $pw
            Remove-Item $pfxPath -Force
          }
          else {
            Write-Host "Code signing disabled (no secrets)." -ForegroundColor Yellow
            ./build-release.ps1
          }

      - name: Verify signature (optional)
        shell: pwsh
        run: |
          if (-not $env:CODESIGN_PFX_BASE64 -or -not $env:CODESIGN_PFX_PASSWORD) {
            Write-Host "Skipping signature verification (no signing secrets)." -ForegroundColor Yellow
            exit 0
          }
          $exe = Get-ChildItem .\dist\colorFabbInstaller_v*.exe | Select-Object -First 1
          if (-not $exe) { throw "No EXE found in dist/" }
          $sig = Get-AuthenticodeSignature $exe.FullName
          $sig | Format-List | Out-String | Write-Host
          if ($sig.Status -eq 'NotSigned') { throw "EXE is not signed." }
          Write-Host "Signature present. Status: $($sig.Status)" -ForegroundColor Green

      - name: Upload artifacts (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: windows-dist
          path: |
            dist/*.exe
            dist/*.sha256.txt

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Build .app via spec
        run: |
          rm -rf dist build
          python -m PyInstaller --noconfirm --clean "./colorFabb Filament Installer.spec"

      - name: Create DMG + SHA256
        shell: bash
        run: |
          set -euo pipefail
          APP_VERSION="$(python ./_version_probe.py | tr -d '\r\n')"
          if [[ -z "$APP_VERSION" || "$APP_VERSION" == "NOTFOUND" || "$APP_VERSION" == "NON_CONSTANT" ]]; then
            echo "Unable to determine VERSION from main.py (got: '$APP_VERSION')" >&2
            exit 1
          fi

          APP_NAME="colorFabbInstaller_v${APP_VERSION}"
          APP_PATH="dist/${APP_NAME}.app"

          if [[ ! -d "$APP_PATH" ]]; then
            echo "Expected app bundle not found: $APP_PATH" >&2
            echo "dist contents:" >&2
            ls -la dist >&2 || true
            exit 1
          fi

          STAGING="dist/dmg-staging"
          rm -rf "$STAGING"
          mkdir -p "$STAGING"
          cp -R "$APP_PATH" "$STAGING/"
          ln -sf /Applications "$STAGING/Applications"

          DMG_PATH="dist/${APP_NAME}.dmg"
          hdiutil create \
            -volname "colorFabb Filament Installer" \
            -srcfolder "$STAGING" \
            -ov -format UDZO \
            "$DMG_PATH"

          HASH="$(shasum -a 256 "$DMG_PATH" | awk '{print tolower($1)}')"
          echo "${HASH}  $(basename "$DMG_PATH")" > "dist/${APP_NAME}.dmg.sha256.txt"

      - name: Upload artifacts (macOS)
        uses: actions/upload-artifact@v4
        with:
          name: macos-dist
          path: |
            dist/*.dmg
            dist/*.dmg.sha256.txt

  release:
    runs-on: ubuntu-latest
    needs:
      - build-windows
      - build-macos
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-dist
          path: dist-artifacts

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-dist
          path: dist-artifacts

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist-artifacts/*.exe
            dist-artifacts/*.sha256.txt
            dist-artifacts/*.dmg
            dist-artifacts/*.dmg.sha256.txt
            CHANGELOG.md
