name: build-and-release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    env:
      CODESIGN_PFX_BASE64: ${{ secrets.CODESIGN_PFX_BASE64 }}
      CODESIGN_PFX_PASSWORD: ${{ secrets.CODESIGN_PFX_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Build EXE (+ optional signing) + SHA256
        shell: pwsh
        run: |
          if ($env:CODESIGN_PFX_BASE64 -and $env:CODESIGN_PFX_PASSWORD) {
            Write-Host "Code signing enabled (secrets provided)." -ForegroundColor Cyan
            $pfxPath = Join-Path $PWD "codesign.pfx"
            try {
              $b64 = ($env:CODESIGN_PFX_BASE64 -replace "\s", "")
              $pfxBytes = [Convert]::FromBase64String($b64)
            }
            catch {
              throw "CODESIGN_PFX_BASE64 is not valid base64 (check copy/paste and line breaks). $_"
            }
            [IO.File]::WriteAllBytes($pfxPath, $pfxBytes)

            # Validate that the PFX can be opened with the supplied password before invoking signtool
            try {
              $flags = [System.Security.Cryptography.X509Certificates.X509KeyStorageFlags]::EphemeralKeySet
              $cert = [System.Security.Cryptography.X509Certificates.X509Certificate2]::new($pfxBytes, $env:CODESIGN_PFX_PASSWORD, $flags)
              Write-Host ("PFX loaded OK. Subject: {0}" -f $cert.Subject) -ForegroundColor Green
              $cert.Dispose()
            }
            catch {
              throw "Unable to open PFX with CODESIGN_PFX_PASSWORD. $_"
            }

            $pw = ConvertTo-SecureString $env:CODESIGN_PFX_PASSWORD -AsPlainText -Force
            ./build-release.ps1 -Sign -PfxPath $pfxPath -PfxPassword $pw
            Remove-Item $pfxPath -Force
          }
          else {
            Write-Host "Code signing disabled (no secrets)." -ForegroundColor Yellow
            ./build-release.ps1
          }

      - name: Verify signature (optional)
        shell: pwsh
        run: |
          if (-not $env:CODESIGN_PFX_BASE64 -or -not $env:CODESIGN_PFX_PASSWORD) {
            Write-Host "Skipping signature verification (no signing secrets)." -ForegroundColor Yellow
            exit 0
          }
          $exe = Get-ChildItem .\dist\colorFabbInstaller_v*.exe | Select-Object -First 1
          if (-not $exe) { throw "No EXE found in dist/" }
          $sig = Get-AuthenticodeSignature $exe.FullName
          $sig | Format-List | Out-String | Write-Host
          if ($sig.Status -ne 'Valid') { throw "Authenticode signature is not valid: $($sig.Status)" }

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.exe
            dist/*.sha256.txt
            CHANGELOG.md
